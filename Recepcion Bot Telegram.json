{
  "name": "Recepcion Bot Telegram",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-test/Telegram",
        "options": {}
      },
      "id": "22b3f868-f7fd-42d8-9b4f-25a6a752fa1e",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -5888,
        768
      ],
      "webhookId": "meetlines-whatsapp-webhook",
      "disabled": true
    },
    {
      "parameters": {
        "url": "={{ \"https://services.meet-lines.com/api/project-credentials/\" + $('Webhook').item.json.headers['x-project-id'] + \"/whatsapp\" }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "12d2b895-60af-4e7b-9a61-a6971f592576",
      "name": "Fetch WhatsApp Credentials",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -5456,
        816
      ],
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5ed0c4e8-4f03-40dc-81d6-277ae6c20c27",
              "name": "projectId",
              "value": "={{ $('Get idproject').item.json.projectId }}",
              "type": "string"
            },
            {
              "id": "e3a2bfba-9612-4490-bb3c-616c09dc3050",
              "name": "phoneNumberId",
              "value": "={{ $('Webhook').item.json.body.entry[0].changes[0].value.metadata.phone_number_id }}",
              "type": "string"
            },
            {
              "id": "9983be08-29f6-4d8c-90e3-f34526691b5d",
              "name": "mensaje",
              "value": "={{ $('Webhook').item.json.body.entry[0].changes[0].value.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "936d593a-8231-4528-8905-73dc58a25840",
              "name": "tonumber",
              "value": "={{ $('Webhook').item.json.body.entry[0].changes[0].value.messages[0].from }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "24bd8fc5-cd21-49ce-99d0-39cb2ca427d2",
      "name": "Extract Message Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -5264,
        816
      ]
    },
    {
      "parameters": {
        "url": "=https://fd874cb30cea.ngrok-free.app/api/projects/by-telegram-token/{{ $json.query.botToken }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -5648,
        784
      ],
      "id": "d89e389a-be9e-4870-8a0a-986c89c877ad",
      "name": "Get idproject",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://services.meet-lines.com/api/Projects/{{ $json.projectId }}/public",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4448,
        656
      ],
      "id": "fe977602-5a72-44a8-af97-16f3bc407339",
      "name": "Get project",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.meet-lines.com/api/projects/{{ $('Get idproject').item.json.projectId }}/knowledge-base/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"projectId\": \"{{ $('Get idproject').item.json.projectId }}\",\n  \"query\": \"{{ $('Extract Message Data').item.json.mensaje }}\",\n  \"activeOnly\": true,\n  \"limit\": 3\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4160,
        656
      ],
      "id": "bca5ea16-c46b-4ff4-a8e3-c662d9a60d69",
      "name": "get respuestas",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://services.meet-lines.com/api/projects/{{ $json.id }}/bot-config",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4304,
        656
      ],
      "id": "5a0af82a-9250-4e52-9ab7-ed3a07abb47d",
      "name": "get bot config",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Extract Message Data').item.json.mensaje }}",
        "options": {
          "systemMessage": "=Eres {{ $('get bot config').item.json.botName || 'el asistente virtual' }} de {{ $('Get project').item.json.name }}.\n\nCONTEXTO:\n- Industria: {{ $('get bot config').item.json.industry }}\n- Tono: {{ $('get bot config').item.json.tone }}\n- Tu rol: Asistente de atenciÃ³n al cliente\n\nINFORMACIÃ“N DE LA BASE DE CONOCIMIENTO:\n{{ $('get respuestas').item.json.answer || 'No se encontrÃ³ informaciÃ³n especÃ­fica en la base de conocimiento.' }}\n\nMENSAJE DEL CLIENTE:\n{{ $('Extract Message Data').item.json.mensaje }}\n\nINSTRUCCIONES DE RESPUESTA:\n\n1. SI LA BASE DE CONOCIMIENTO TIENE INFORMACIÃ“N (arriba):\n   - Usa ESA informaciÃ³n para responder\n   - SÃ© preciso y especÃ­fico\n   - No inventes ni agregues informaciÃ³n extra\n\n2. SI LA BASE DE CONOCIMIENTO ESTÃ VACÃA:\n   - Responde con informaciÃ³n general sobre {{ $('get bot config').item.json.industry }}\n   - Ofrece contactar directamente para detalles especÃ­ficos\n   - Ejemplo: \"Para informaciÃ³n especÃ­fica sobre [tema], te recomiendo contactarnos directamente. Â¿Hay algo mÃ¡s en lo que pueda ayudarte? ðŸ˜Š\"\n\n3. TEMAS PERMITIDOS:\n   âœ… Servicios de {{ $('Get project').item.json.name }}\n   âœ… Precios y promociones\n   âœ… Horarios de atenciÃ³n\n   âœ… UbicaciÃ³n y contacto\n\n4. TEMAS PROHIBIDOS:\n   âŒ Temas generales (clima, noticias, polÃ­tica)\n   âŒ Otros negocios\n   âŒ Temas fuera de {{ $('get bot config').item.json.industry }}\n   \n   Si preguntan algo prohibido: \"Lo siento, solo puedo ayudarte con informaciÃ³n sobre {{ $('Get project').item.json.name }}. Â¿Tienes alguna pregunta sobre nuestros servicios? ðŸ˜Š\"\n\n5. ESTILO:\n   - MÃ¡ximo 2-3 lÃ­neas\n   - Tono: {{ $('get bot config').item.json.tone }}\n   - Usa emojis ocasionalmente\n   - SÃ© natural y conversacional\n   - NO menciones palabras como \"agendar\", \"reservar\", \"cita\"\n\nResponde ahora:"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -4016,
        656
      ],
      "id": "6d8f52b6-ca2f-4579-a10e-88e78274544f",
      "name": "Agente recepcion"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el output, puede venir de diferentes nodos\nconst aiOutput = $input.item.json.output || $input.item.json.aiResponse || '';\n\n// Validar que aiOutput existe y es string\nif (!aiOutput || typeof aiOutput !== 'string') {\n  return [{\n    json: {\n      cleanResponse: '',\n      intent: null,\n      sentiment: null,\n      intentConfidence: null,\n      error: 'No AI output found'\n    }\n  }];\n}\n\n// Extraer la respuesta limpia\nconst lines = aiOutput.split('\\n');\nlet cleanResponse = '';\nlet intent = null;\nlet sentiment = null;\n\nfor (const line of lines) {\n  if (line.startsWith('INTENT:')) {\n    intent = line.replace('INTENT:', '').trim();\n  } else if (line.startsWith('SENTIMENT:')) {\n    sentiment = parseFloat(line.replace('SENTIMENT:', '').trim());\n  } else if (line.trim()) {\n    cleanResponse += line + '\\n';\n  }\n}\n\nreturn [{\n  json: {\n    cleanResponse: cleanResponse.trim(),\n    intent: intent,\n    sentiment: sentiment,\n    intentConfidence: intent ? 0.85 : null\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3728,
        656
      ],
      "id": "9c6dd296-7ce4-4c06-9098-a94b7bceead1",
      "name": "Parse AI Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.meet-lines.com/api/projects/{{ $('Extract Message Data').item.json.projectId }}/conversations",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"projectId\": \"{{ $('Get project').first().json.id }}\",\n  \"customerPhone\": \"{{ $('Extract Message Data').first().json.tonumber }}\",\n  \"customerName\": \"Unknown\",\n  \"customerMessage\": \"{{ $('Extract Message Data').first().json.mensaje }}\",\n  \"botResponse\": \"Â¡Perfecto! Vamos a agendar tu cita.\",\n  \"botType\": \"transactional\",\n  \"intent\": \"agendar_cita\",\n  \"metadataJson\": \"{\\\"step\\\":\\\"ask_service\\\",\\\"selectedService\\\":null,\\\"selectedServiceId\\\":null,\\\"selectedDate\\\":null,\\\"selectedTime\\\":null,\\\"selectedEmployeeId\\\":null,\\\"selectedEmployeeName\\\":null}\",\n  \"lastMessage\": \"{{ $('Extract Message Data').first().json.mensaje }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3552,
        656
      ],
      "id": "6179c908-ca9e-421c-8dcb-2809df10cab1",
      "name": "guardar conversacion",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener respuesta de OpenAI del input actual\nconst aiResponse = ($input.first().json.output || '').toLowerCase();\n\n// Obtener mensaje del usuario del nodo Extract Message Data\nlet userMessage = '';\n\n// Buscar en todos los items del input\nconst allItems = $input.all();\nfor (const item of allItems) {\n  if (item.json.mensaje) {\n    userMessage = item.json.mensaje.toLowerCase();\n    break;\n  }\n}\n\n// Si no estÃ¡ en el input actual, intentar acceder directamente al nodo\nif (!userMessage) {\n  try {\n    userMessage = ($('Extract Message Data').first().json.mensaje || '').toLowerCase();\n  } catch (e) {\n    userMessage = '';\n  }\n}\n\n// Keywords de agendamiento - SOLO en mensaje del USUARIO\nconst bookingKeywords = [\n  'quiero agendar',\n  'necesito agendar',\n  'quiero reservar',\n  'necesito reservar',\n  'quiero una cita',\n  'necesito una cita',\n  'agendar cita',\n  'reservar cita',\n  'sacar cita',\n  'pedir cita',\n  'hacer cita'\n];\n\n// SOLO detectar si el USUARIO menciona agendamiento explÃ­citamente\nconst userHasIntent = bookingKeywords.some(k => userMessage.includes(k));\n\n// NO detectar en respuesta de AI (eso causa falsos positivos)\nconst hasBookingIntent = userHasIntent;\n\nreturn {\n  json: {\n    intent: hasBookingIntent ? 'BOOKING' : 'GENERAL',\n    aiResponse: $input.first().json.output,\n    userMessage: userMessage,\n    detectedIn: userHasIntent ? 'user_message' : 'none'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3408,
        656
      ],
      "id": "0744593d-554d-499e-8d31-78aa9c9d409b",
      "name": "Detect Booking Intent"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "BOOKING",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0a610296-5de5-499b-af69-457b99f54280"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d52d149a-5268-49e5-b9a4-ff9a3d84688d",
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "GENERAL",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -3200,
        656
      ],
      "id": "c47d6c33-cde8-4b15-b949-f35530b7e2e7",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rojascrew.app.n8n.cloud/webhook/webhook/transactional-bot",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"from\": \"{{$('Extract Message Data').first().json.tonumber}}\",\n  \"message\": \"{{$('Extract Message Data').first().json.mensaje}}\",\n  \"projectId\": \"{{$('Extract Message Data').first().json.projectId}}\",\n  \"phoneNumberId\": \"{{$('Extract Message Data').first().json.phoneNumberId}}\",\n  \"conversationId\": \"{{$json.conversationId || $('guardar conversacion').first().json.id}}\",\n  \"triggeredBy\": \"reception_bot\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2624,
        448
      ],
      "id": "9561ae52-bfdf-489c-bc40-59aca29a7055",
      "name": "Trigger Bot 2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.meet-lines.com/api/whatsapp/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "=X-Project-Id",
              "value": "={{ $('Get idproject').item.json.projectId }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"toPhoneNumber\": \"{{ $('Extract Message Data').item.json.tonumber }}\",\n  \"messageText\": \"{{ $('Parse AI Response').item.json.cleanResponse }}\"\n}",
        "options": {}
      },
      "id": "984b3dc8-d879-433d-9eb1-3e42352dfcaa",
      "name": "Send WhatsApp Message Bot recepcion",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2784,
        736
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.meet-lines.com/api/whatsapp/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "=X-Project-Id",
              "value": "={{ $('Get idproject').item.json.projectId }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"toPhoneNumber\": \"{{$('Extract Message Data').first().json.tonumber}}\",\n  \"messageText\": \"Â¡Perfecto! ðŸ“… Te ayudarÃ© a agendar tu cita. Un momento...\"\n}",
        "options": {}
      },
      "id": "632e5477-2244-4537-a56b-cd8109aac898",
      "name": "Send WhatsApp Message route bot Transaction",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2800,
        560
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extract Message Data').item.json.tonumber }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -3904,
        960
      ],
      "id": "03ea4ef5-002a-4330-94c9-8d9fd8172500",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst conversations = response.body || response; // Si viene en body, Ãºsalo, sino usa response directo\nconst webhookData = $('Extract Message Data').first().json;\n\nconst now = new Date();\nconst oneDayAgo = new Date(now.getTime() - 24*60*60*1000);\n\nlet hasActiveConversation = false;\nlet conversationId = null;\n\nif (Array.isArray(conversations) && conversations.length > 0) {\n  const transactionalConvs = conversations\n    .filter(c => c.botType === 'transactional')\n    .filter(c => {\n      const created = new Date(c.createdAt);\n      return created > oneDayAgo;\n    })\n    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  \n  if (transactionalConvs.length > 0) {\n    const latest = transactionalConvs[0];\n    \n    let isDone = false;\n    if (latest.metadataJson) {\n      try {\n        const metadata = JSON.parse(latest.metadataJson);\n        isDone = metadata.step === 'done';\n      } catch (e) {}\n    }\n    \n    if (!isDone) {\n      hasActiveConversation = true;\n      conversationId = latest.id;\n    }\n  }\n}\n\nreturn [{\n  json: {\n    hasActiveConversation,\n    conversationId,\n    ...webhookData\n  },\n  pairedItem: 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4896,
        800
      ],
      "id": "dda73e93-a999-4473-ad75-2dcccff21ade",
      "name": "Parse Active Conversation"
    },
    {
      "parameters": {
        "url": "=https://services.meet-lines.com/api/projects/{{$('Extract Message Data').first().json.projectId}}/conversations/customer/{{$('Extract Message Data').first().json.tonumber}}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -5056,
        800
      ],
      "id": "c1cbe4a7-33a4-4023-9c59-8de30c6ea90a",
      "name": "Check Active Conversation",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.hasActiveConversation }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "cc6cb8bf-e86e-4dfb-8430-97f538785515"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -4688,
        736
      ],
      "id": "40593621-e082-4940-a0e5-2b9f168308fb",
      "name": "has Active Conversation"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.meet-lines.com/api/projects/{{ $('Get project').item.json.id }}/conversations",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"projectId\": \"{{ $('Get project').first().json.id }}\",\n  \"customerPhone\": \"{{ $('Extract Message Data').first().json.tonumber }}\",\n  \"customerName\": \"Unknown\",\n  \"customerMessage\": \"{{ $('Extract Message Data').first().json.mensaje }}\",\n  \"botResponse\": \"Â¡Perfecto! Vamos a agendar tu cita.\",\n  \"botType\": \"transactional\",\n  \"intent\": \"agendar_cita\",\n  \"metadataJson\": \"{\\\"step\\\":\\\"ask_service\\\",\\\"selectedService\\\":null,\\\"selectedServiceId\\\":null,\\\"selectedDate\\\":null,\\\"selectedTime\\\":null,\\\"selectedEmployeeId\\\":null,\\\"selectedEmployeeName\\\":null}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3024,
        608
      ],
      "id": "4db3f0c6-bb06-47ab-9f4b-b30f8f2b4ecc",
      "name": "HTTP Request",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -4096,
        880
      ],
      "id": "85fcfd9b-e5ab-4ee4-a5d5-44bc64770dea",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "iwKj54bMuqT4S83f",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://fd874cb30cea.ngrok-free.app/api/telegram/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "=X-Project-Id",
              "value": "={{ $('Extract Message Data1').item.json.projectId }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"toChatId\": \"{{ $('Extract Message Data1').item.json.tonumber }}\",\n  \"messageText\": \"{{ $('Parse AI Response1').item.json.cleanResponse }}\"\n}",
        "options": {}
      },
      "id": "5ddf3a17-96ee-4464-b897-fab13c3c86f1",
      "name": "Send Telegram Message Bot recepcion",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2608,
        2960
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://fd874cb30cea.ngrok-free.app/api/telegram/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "=X-Project-Id",
              "value": "={{ $('Extract Message Data1').item.json.projectId }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"toChatId\": \"{{$('Extract Message Data1').first().json.tonumber}}\",\n  \"messageText\": \"Â¡Perfecto! ðŸ“… Te ayudarÃ© a agendar tu cita. Un momento...\"\n}",
        "options": {}
      },
      "id": "5d4a753a-d006-4cd5-a7ce-c1f46b074e9b",
      "name": "Send Telegram Message route bot Transaction",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2624,
        2784
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-test/Telegram",
        "options": {}
      },
      "id": "0cca8262-bfd3-4ff9-a73f-197b1a3c5052",
      "name": "Webhook1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -5712,
        2992
      ],
      "webhookId": "meetlines-telegram-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5ed0c4e8-4f03-40dc-81d6-277ae6c20c27",
              "name": "projectId",
              "value": "={{ $('Webhook1').item.json.headers['x-project-id'] }}",
              "type": "string"
            },
            {
              "id": "e3a2bfba-9612-4490-bb3c-616c09dc3050",
              "name": "botToken",
              "value": "={{ $('Webhook1').item.json.headers['x-telegram-bot-token'] }}",
              "type": "string"
            },
            {
              "id": "9983be08-29f6-4d8c-90e3-f34526691b5d",
              "name": "mensaje",
              "value": "={{ $('Webhook1').item.json.body.message.text }}",
              "type": "string"
            },
            {
              "id": "936d593a-8231-4528-8905-73dc58a25840",
              "name": "tonumber",
              "value": "={{ $('Webhook1').item.json.body.message.chat.id.toString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3a8e997c-1fdd-45ac-b65c-f31192cb5a24",
      "name": "Extract Message Data1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -5088,
        3040
      ]
    },
    {
      "parameters": {
        "url": "=https://fd874cb30cea.ngrok-free.app/api/Projects/{{ $json.projectId }}/public",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4272,
        2880
      ],
      "id": "10088880-daef-4aea-91ac-6a5b2cfba6dd",
      "name": "Get project1",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://fd874cb30cea.ngrok-free.app/api/projects/{{ $('Extract Message Data1').item.json.projectId }}/knowledge-base/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"projectId\": \"{{ $('Extract Message Data1').item.json.projectId }}\",\n  \"query\": \"{{ $('Extract Message Data1').item.json.mensaje }}\",\n  \"activeOnly\": true,\n  \"limit\": 3\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3984,
        2880
      ],
      "id": "de4ff183-7cdd-48ca-b2e3-20407ec4e152",
      "name": "get respuestas1",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://fd874cb30cea.ngrok-free.app/api/projects/{{ $json.id }}/bot-config",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4128,
        2880
      ],
      "id": "053bee12-1964-4cb7-ab3e-28a7e6ef8335",
      "name": "get bot config1",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Extract Message Data1').item.json.mensaje }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=Eres {{ $('get bot config1').item.json.botName || 'el asistente virtual' }} de {{ $('Get project1').item.json.name }}.\n\nCONTEXTO:\n- Industria: {{ $('get bot config1').item.json.industry }}\n- Tono: {{ $('get bot config1').item.json.tone }}\n- Tu rol: Asistente de atenciÃ³n al cliente\n\nINFORMACIÃ“N DE LA BASE DE CONOCIMIENTO:\n{{ $('get respuestas1').item.json.answer || 'No se encontrÃ³ informaciÃ³n especÃ­fica en la base de conocimiento.' }}\n\nMENSAJE DEL CLIENTE:\n{{ $('Extract Message Data1').item.json.mensaje }}\n\nINSTRUCCIONES DE RESPUESTA:\n\n1. SI LA BASE DE CONOCIMIENTO TIENE INFORMACIÃ“N (arriba):\n   - Usa ESA informaciÃ³n para responder\n   - SÃ© preciso y especÃ­fico\n   - No inventes ni agregues informaciÃ³n extra\n\n2. SI LA BASE DE CONOCIMIENTO ESTÃ VACÃA:\n   - Responde con informaciÃ³n general sobre {{ $('get bot config1').item.json.industry }}\n   - Ofrece contactar directamente para detalles especÃ­ficos\n   - Ejemplo: \"Para informaciÃ³n especÃ­fica sobre [tema], te recomiendo contactarnos directamente. Â¿Hay algo mÃ¡s en lo que pueda ayudarte? ðŸ˜Š\"\n\n3. TEMAS PERMITIDOS:\n   âœ… Servicios de {{ $('Get project1').item.json.name }}\n   âœ… Precios y promociones\n   âœ… Horarios de atenciÃ³n\n   âœ… UbicaciÃ³n y contacto\n\n4. TEMAS PROHIBIDOS:\n   âŒ Temas generales (clima, noticias, polÃ­tica)\n   âŒ Otros negocios\n   âŒ Temas fuera de {{ $('get bot config1').item.json.industry }}\n   \n   Si preguntan algo prohibido: \"Lo siento, solo puedo ayudarte con informaciÃ³n sobre {{ $('Get project1').item.json.name }}. Â¿Tienes alguna pregunta sobre nuestros servicios? ðŸ˜Š\"\n\n5. ESTILO:\n   - MÃ¡ximo 2-3 lÃ­neas\n   - Tono: {{ $('get bot config1').item.json.tone }}\n   - Usa emojis ocasionalmente\n   - SÃ© natural y conversacional\n\n6. CLASIFICACIÃ“N DE INTENCIÃ“N:\n   Debes identificar la intenciÃ³n del usuario:\n   - \"agendar_cita\": Si el usuario menciona agendar, reservar, cita, turno, apartar, programar\n   - \"consultar_info\": Preguntas sobre servicios, precios, horarios, ubicaciÃ³n\n   - \"general_inquiry\": Saludos, despedidas, agradecimientos\n   - \"fuera_de_contexto\": Temas prohibidos o fuera del negocio\n\nFORMATO DE RESPUESTA OBLIGATORIO:\nDebes responder SIEMPRE en formato JSON vÃ¡lido con esta estructura exacta:\n{\n  \"response\": \"tu mensaje aquÃ­\",\n  \"intent\": \"tipo_de_intenciÃ³n\"\n}\n\nEjemplo:\n{\n  \"response\": \"Â¡Hola! Soy el asistente de Pottercloud. Â¿En quÃ© puedo ayudarte hoy? ðŸ˜Š\",\n  \"intent\": \"general_inquiry\"\n}\n\nResponde ahora en formato JSON:"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -3840,
        2880
      ],
      "id": "dacf6d0b-ba12-465d-bd91-6291fbaf8e26",
      "name": "Agente recepcion1"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el output, puede venir de diferentes nodos\nconst aiOutput = $input.item.json.output || $input.item.json.aiResponse || '';\n\n// Validar que aiOutput existe y es string\nif (!aiOutput || typeof aiOutput !== 'string') {\n  return [{\n    json: {\n      cleanResponse: '',\n      intent: 'general_inquiry',\n      sentiment: null,\n      intentConfidence: null,\n      error: 'No AI output found'\n    }\n  }];\n}\n\ntry {\n  // Remover code blocks de markdown si existen (```json ... ```)\n  let cleanJson = aiOutput\n    .replace(/```json\\n?/g, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n\n  // Intentar parsear como JSON\n  const parsed = JSON.parse(cleanJson);\n  \n  return [{\n    json: {\n      cleanResponse: parsed.response || '',\n      intent: parsed.intent || 'general_inquiry',\n      sentiment: parsed.sentiment || null,\n      intentConfidence: parsed.intent ? 0.85 : null\n    }\n  }];\n  \n} catch (e) {\n  // Si falla el parse, intentar el formato anterior (INTENT: / SENTIMENT:)\n  const lines = aiOutput.split('\\n');\n  let cleanResponse = '';\n  let intent = null;\n  let sentiment = null;\n\n  for (const line of lines) {\n    if (line.startsWith('INTENT:')) {\n      intent = line.replace('INTENT:', '').trim();\n    } else if (line.startsWith('SENTIMENT:')) {\n      sentiment = parseFloat(line.replace('SENTIMENT:', '').trim());\n    } else if (line.trim()) {\n      cleanResponse += line + '\\n';\n    }\n  }\n  \n  // Si no se encontrÃ³ intent en el formato anterior, usar el texto directo\n  if (!cleanResponse && !intent) {\n    cleanResponse = aiOutput;\n    intent = 'general_inquiry';\n  }\n\n  return [{\n    json: {\n      cleanResponse: cleanResponse.trim() || aiOutput,\n      intent: intent || 'general_inquiry',\n      sentiment: sentiment,\n      intentConfidence: intent ? 0.85 : null\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3552,
        2880
      ],
      "id": "6893e836-9a64-4175-8dc1-e3f9d60d691b",
      "name": "Parse AI Response1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://fd874cb30cea.ngrok-free.app/api/projects/{{ $('Extract Message Data1').item.json.projectId }}/conversations",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"projectId\": \"{{ $('Get project1').first().json.id }}\",\n  \"customerPhone\": \"{{ $('Extract Message Data1').first().json.tonumber }}\",\n  \"customerName\": \"Unknown\",\n  \"customerMessage\": \"{{ $('Extract Message Data1').first().json.mensaje }}\",\n  \"botResponse\": \"{{ $json.cleanResponse }}\",\n  \"botType\": \"transactional\",\n  \"intent\": \"agendar_cita\",\n  \"metadataJson\": \"{\\\"step\\\":\\\"ask_service\\\",\\\"selectedService\\\":null,\\\"selectedServiceId\\\":null,\\\"selectedDate\\\":null,\\\"selectedTime\\\":null,\\\"selectedEmployeeId\\\":null,\\\"selectedEmployeeName\\\":null}\",\n  \"lastMessage\": \"{{ $('Extract Message Data1').first().json.mensaje }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3376,
        2880
      ],
      "id": "397c712a-5290-46bc-b6a0-2a2c6f89d313",
      "name": "guardar conversacion1",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener respuesta de OpenAI del input actual\nconst aiResponse = ($input.first().json.output || '').toLowerCase();\n\n// Obtener mensaje del usuario del nodo Extract Message Data\nlet userMessage = '';\n\n// Buscar en todos los items del input\nconst allItems = $input.all();\nfor (const item of allItems) {\n  if (item.json.mensaje) {\n    userMessage = item.json.mensaje.toLowerCase();\n    break;\n  }\n}\n\n// Si no estÃ¡ en el input actual, intentar acceder directamente al nodo\nif (!userMessage) {\n  try {\n    userMessage = ($('Extract Message Data1').first().json.mensaje || '').toLowerCase();\n  } catch (e) {\n    userMessage = '';\n  }\n}\n\n// Keywords de agendamiento - SOLO en mensaje del USUARIO\nconst bookingKeywords = [\n  'quiero agendar',\n  'necesito agendar',\n  'quiero reservar',\n  'necesito reservar',\n  'quiero una cita',\n  'necesito una cita',\n  'agendar cita',\n  'reservar cita',\n  'sacar cita',\n  'pedir cita',\n  'hacer cita'\n];\n\n// SOLO detectar si el USUARIO menciona agendamiento explÃ­citamente\nconst userHasIntent = bookingKeywords.some(k => userMessage.includes(k));\n\n// NO detectar en respuesta de AI (eso causa falsos positivos)\nconst hasBookingIntent = userHasIntent;\n\nreturn {\n  json: {\n    intent: hasBookingIntent ? 'BOOKING' : 'GENERAL',\n    aiResponse: $input.first().json.output,\n    userMessage: userMessage,\n    detectedIn: userHasIntent ? 'user_message' : 'none'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3232,
        2880
      ],
      "id": "3a6128ef-9122-402d-aff7-0a4526398653",
      "name": "Detect Booking Intent1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "BOOKING",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0a610296-5de5-499b-af69-457b99f54280"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d52d149a-5268-49e5-b9a4-ff9a3d84688d",
                    "leftValue": "={{$json.intent}}",
                    "rightValue": "GENERAL",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -3024,
        2880
      ],
      "id": "35e95d3e-c543-4866-a849-2d93561f209f",
      "name": "Switch1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://rojascrew.app.n8n.cloud/webhook/webhook/transactional-bot",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"from\": \"{{$('Extract Message Data1').first().json.tonumber}}\",\n  \"message\": \"{{$('Extract Message Data1').first().json.mensaje}}\",\n  \"projectId\": \"{{$('Extract Message Data1').first().json.projectId}}\",\n  \"phoneNumberId\": \"{{$('Extract Message Data1').first().json.projectId}}\",\n  \"conversationId\": \"{{$json.conversationId || $('guardar conversacion1').first().json.id}}\",\n  \"triggeredBy\": \"reception_bot\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2448,
        2672
      ],
      "id": "6fb27e7b-03d8-4ec7-890b-6c43270dfd5b",
      "name": "Trigger Bot "
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extract Message Data1').item.json.tonumber }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -3728,
        3184
      ],
      "id": "b5eada6b-227f-49e5-a107-e918dc1e670b",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst conversations = response.body || response; // Si viene en body, Ãºsalo, sino usa response directo\nconst webhookData = $('Extract Message Data1').first().json;\n\nconst now = new Date();\nconst oneDayAgo = new Date(now.getTime() - 24*60*60*1000);\n\nlet hasActiveConversation = false;\nlet conversationId = null;\n\nif (Array.isArray(conversations) && conversations.length > 0) {\n  const transactionalConvs = conversations\n    .filter(c => c.botType === 'transactional')\n    .filter(c => {\n      const created = new Date(c.createdAt);\n      return created > oneDayAgo;\n    })\n    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  \n  if (transactionalConvs.length > 0) {\n    const latest = transactionalConvs[0];\n    \n    let isDone = false;\n    if (latest.metadataJson) {\n      try {\n        const metadata = JSON.parse(latest.metadataJson);\n        isDone = metadata.step === 'done';\n      } catch (e) {}\n    }\n    \n    if (!isDone) {\n      hasActiveConversation = true;\n      conversationId = latest.id;\n    }\n  }\n}\n\nreturn [{\n  json: {\n    hasActiveConversation,\n    conversationId,\n    ...webhookData\n  },\n  pairedItem: 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4720,
        3024
      ],
      "id": "63aa02ac-7675-400b-b468-517e843bc8d9",
      "name": "Parse Active Conversation1"
    },
    {
      "parameters": {
        "url": "=https://fd874cb30cea.ngrok-free.app/api/projects/{{$('Extract Message Data1').first().json.projectId}}/conversations/customer/{{$('Extract Message Data1').first().json.tonumber}}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4880,
        3024
      ],
      "id": "a47cd890-efcc-4412-8a07-24eebba6f98e",
      "name": "Check Active Conversation1",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.hasActiveConversation }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "cc6cb8bf-e86e-4dfb-8430-97f538785515"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -4512,
        2960
      ],
      "id": "c50c9b6a-3a64-41ef-b6f3-4730f622911d",
      "name": "has Active Conversation1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://fd874cb30cea.ngrok-free.app/api/projects/{{ $('Get project1').item.json.id }}/conversations",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpMultipleHeadersAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"projectId\": \"{{ $('Get project1').first().json.id }}\",\n  \"customerPhone\": \"{{ $('Extract Message Data1').first().json.tonumber }}\",\n  \"customerName\": \"Unknown\",\n  \"customerMessage\": \"{{ $('Extract Message Data1').first().json.mensaje }}\",\n  \"botResponse\": \"Â¡Perfecto! Vamos a agendar tu cita.\",\n  \"botType\": \"transactional\",\n  \"intent\": \"agendar_cita\",\n  \"metadataJson\": \"{\\\"step\\\":\\\"ask_service\\\",\\\"selectedService\\\":null,\\\"selectedServiceId\\\":null,\\\"selectedDate\\\":null,\\\"selectedTime\\\":null,\\\"selectedEmployeeId\\\":null,\\\"selectedEmployeeName\\\":null}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2848,
        2832
      ],
      "id": "ccb0362d-2634-4267-8bbd-be79e636b192",
      "name": "HTTP Request1",
      "credentials": {
        "httpMultipleHeadersAuth": {
          "id": "7xzvYiTLUbiNIgOp",
          "name": "Multiple Headers Auth account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -3920,
        3104
      ],
      "id": "9e5efbcf-2275-4b19-be9d-bfce34a7ba34",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "iwKj54bMuqT4S83f",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get idproject",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch WhatsApp Credentials": {
      "main": [
        [
          {
            "node": "Extract Message Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Data": {
      "main": [
        [
          {
            "node": "Check Active Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get idproject": {
      "main": [
        [
          {
            "node": "Fetch WhatsApp Credentials",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get project": {
      "main": [
        [
          {
            "node": "get bot config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get respuestas": {
      "main": [
        [
          {
            "node": "Agente recepcion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get bot config": {
      "main": [
        [
          {
            "node": "get respuestas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente recepcion": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "guardar conversacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "guardar conversacion": {
      "main": [
        [
          {
            "node": "Detect Booking Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect Booking Intent": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send WhatsApp Message Bot recepcion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Agente recepcion",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Parse Active Conversation": {
      "main": [
        [
          {
            "node": "has Active Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Active Conversation": {
      "main": [
        [
          {
            "node": "Parse Active Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has Active Conversation": {
      "main": [
        [
          {
            "node": "Get project",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Trigger Bot 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Send WhatsApp Message route bot Transaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp Message route bot Transaction": {
      "main": [
        [
          {
            "node": "Trigger Bot 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agente recepcion",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Send Telegram Message route bot Transaction": {
      "main": [
        [
          {
            "node": "Trigger Bot ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Extract Message Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Data1": {
      "main": [
        [
          {
            "node": "Check Active Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get project1": {
      "main": [
        [
          {
            "node": "get bot config1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get respuestas1": {
      "main": [
        [
          {
            "node": "Agente recepcion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get bot config1": {
      "main": [
        [
          {
            "node": "get respuestas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente recepcion1": {
      "main": [
        [
          {
            "node": "Parse AI Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response1": {
      "main": [
        [
          {
            "node": "guardar conversacion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "guardar conversacion1": {
      "main": [
        [
          {
            "node": "Detect Booking Intent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect Booking Intent1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Telegram Message Bot recepcion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "Agente recepcion1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Parse Active Conversation1": {
      "main": [
        [
          {
            "node": "has Active Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Active Conversation1": {
      "main": [
        [
          {
            "node": "Parse Active Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has Active Conversation1": {
      "main": [
        [
          {
            "node": "Get project1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Trigger Bot ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Send Telegram Message route bot Transaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Agente recepcion1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "638981b4-59b1-4601-ac7d-2695e3ab2753",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6a99983c5c90dd99bc97a6ac4aeb4042f3342ff3c213dd96a373584027e31ffe"
  },
  "id": "lGGk9lfJk0tCB1O2",
  "tags": []
}